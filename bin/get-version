#!/usr/bin/env php
<?php

declare(strict_types=1);

$hash = getCurrentRevision();
$tag = getCurrentVersion($hash);

echo ($tag ?? '') . "\n";
exit(0);

function getCurrentRevision(): string
{
    $cmdline = vsprintf('/usr/bin/env %s log -n 1 --pretty=%s', [
        escapeshellarg('git'),
        escapeshellarg('format:%H'),
    ]);
    exec($cmdline, $lines, $status);
    if ($status !== 0) {
        exit(1);
    }

    $line = trim((string)$lines[0]);
    if (!preg_match('/\A[0-9a-f]{40}\z/', $line)) {
        exit(1);
    }

    return $line;
}

function getCurrentVersion(string $fullHash): ?string
{
    if (!$versions = getVersionTags($fullHash)) {
        return null;
    }

    return $versions[0];
}

function getVersionTags(string $fullHash): array
{
    $cmdline = vsprintf('/usr/bin/env %s tag --points-at=%s', [
        escapeshellarg('git'),
        escapeshellarg($fullHash),
    ]);
    exec($cmdline, $lines, $status);
    if ($status !== 0) {
        exit(1);
    }

    $versions = array_filter(
        array_map(fn($line) => trim($line), $lines),
        fn($line) => preg_match('/^v([0-9.]+)$/', $line)
    );
    usort($versions, fn($a, $b) => version_compare($b, $a));
    return array_values($versions);
}
